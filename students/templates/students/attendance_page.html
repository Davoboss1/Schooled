{% load custom_utils %}
<div class="my-1 mx-auto w-100 py-4" style="max-width:500px;">
    <!-- Attendance Mark -->
    <div class="d-flex flex-column mb-2" hx-get="{% url 'students:attendance_page' type %}" hx-target="#main">
        <span class="fa fa-3x fa-repeat mx-auto" id="refresh"></span>
        <small class="mx-auto">Refresh</small>
    </div>
    <div class="d-flex my-3">

        <h6 class="my-auto ml-3">Select Date : </h6>

        <div class="d-flex date-container ">
            <span class="fa fa-calendar vcenter ml-2">
            </span>
            <input class="date-input" type="date" value="{{date}}" hx-get="{% url 'students:attendance_page' type %}"
                hx-target="#main" hx-loading-target="#attendance-progress" hx-error-target="#date-error"
                hx-trigger="change" hx-vals="js:{date: event.target.value}">

        </div>
    </div>
    <div class="m-2" id="date-error"></div>
    <div class="m-2" id="attendance-progress"></div>
    {% if not all_students.exists %}
    <div class="alert alert-warning text-center">
        No students in this class
    </div>
    {% endif %}


    <div id="attendance-mark">

        <!-- Button to switch to attendance view -->
        <button class="btn btn-light btn-block mt-3" onclick="switchAttendance(true);">View students attendance</button>


        <!-- Attendance mark form -->
        <form method="post" hx-post="{% url 'students:mark' date %}" hx-target="#form-status" id="mark-form">
            <h6 class="my-3">Mark attendance for {{date|to_date|date:"l jS, F Y"}}</h6>
            <!-- Mark and Unmark all buttons -->
            <div class="mark-all-container">
                <button class="btn btn-info mx-auto" id="markallBtn" onclick="markAll(true);" type="button">Mark all
                </button>
                <button class="btn btn-info mx-auto" id="markallBtn" onclick="markAll(false);" type="button">Unmark all
                </button>
            </div>

            <!-- Attendance marking table -->
            <table class="table attendance-table table-hover">
                <!-- Table head -->
                <thead class="thead-light">
                    <th style="width:15%;">No</th>
                    <th>Full Name</th>
                    <th>Present</th>
                </thead>

                <!-- Body of the table -->
                <tbody>
                    <!-- Test rows of the table -->
                    <!-- Loop should start here -->
                    {% csrf_token %}
                    {% for students in all_students %}
                    <tr>
                        <td>{{forloop.counter}}</td>
                        <td>{{students.name}} </td>
                        <td><input type="checkbox" class="student-checkbox" name="present" value="{{students.id}}" {% if students in attendance %}checked{% endif %}></td>
                    </tr>
                    {% endfor %}

                    <!-- Loop Should end here -->
                    <!-- Remaining rows -->
                    <!-- Should be deleted -->

                    <!-- Deletable rows ends here -->
                </tbody>

            </table>
            <!-- Submit Button -->
            <div class="mark-all-container">
                <button id="attendance-submit" class="btn btn-success mx-auto w-75" type="submit">Submit</button>
            </div>

        </form>
        <div id="form-status">

        </div>
    </div>



    <!-- Attendance view -->
    <div id="attendance-view" style="display:none;">
        <!-- Button to switch to attendance mark -->
        <button class="btn btn-light btn-block mt-3" onclick="switchAttendance(false);">Mark students attendance</button>

        <!-- attendance view container -->
        <div>

            <!-- Date view container -->
            <div class="jumbotron mt-3">
                Showing date for <span id="dateView">{{date|to_date|date:"l jS, F Y"}}</span>
            </div>

            <!-- Attendance view table -->
            <table class="table attendance-table table-hover">
                <!-- Table head -->
                <thead class="thead-light">
                    <th style="width:15%;">No</th>
                    <th>Full Name</th>
                    <th>Status</th>
                </thead>

                <!-- Table body -->
                <tbody>
                    <!-- Table row -->
                    <!-- badge-success should be used for a student that is present -->
                    <!-- badge-danger should be used for a student that is absent -->
                    <!-- First row 
                        Shows present example
                    -->
                    {% for students in all_students %}
                    {% if students in attendance %}
                    <tr>
                        <td>{{forloop.counter}}</td>
                        <td>
                            {{students.name}} </td>
                        <td><span class="badge badge-success">Present</span></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td>{{forloop.counter}}</td>
                        <td>{{students.name}}</td>
                        <td><span class="badge badge-danger">Absent</span></td>
                    </tr>
                    {% endif %}
                    {% endfor %}


                </tbody>

            </table>

        </div>

    </div>

    <!-- View amount of present and absent students -->
    <div class="d-flex">
        <h6 class="mx-auto">Student Present : </h6>
        <h6 class="mx-auto" id="presentNo">{{ attendance.count |default:0 }}</h6>
        <h6 class="mx-auto">Student Absent : </h6>
        <h6 class="mx-auto" x-text="{{all_students.count|default:0}}-{{attendance.count|default:0}}" id="absentNo"></h6>
    </div>


</div>


<script>

    var attendance_mark = document.getElementById('attendance-mark');
    var attendance_view = document.getElementById("attendance-view");

    //For marking and counting attendance checkbox
    //Next three lines gets needed elements from dom.
    var student_checkbox = document.getElementsByClassName("student-checkbox");
    var present_no = document.getElementById("presentNo");
    var absent_no = document.getElementById("absentNo");

    //Counting no of students present and absent
    for (let i = 0; i < student_checkbox.length; i++) {
        student_checkbox[i].onclick = function () {
            let present_count = parseInt(present_no.innerHTML);
            let absent_count = parseInt(absent_no.innerHTML);
            if (this.checked === true) {
                present_no.innerHTML = present_count + 1;
                absent_no.innerHTML = absent_count - 1;
            } else {
                present_no.innerHTML = present_count - 1;
                absent_no.innerHTML = absent_count + 1;
            }
        };

    }


    //Mark all funtion to mark and unmark all.
    function markAll(mark) {
        for (let i = 0; i < student_checkbox.length; i++) {
            if (mark) {
                student_checkbox[i].checked = true;
            } else {
                student_checkbox[i].checked = false;
            }
        }
        if (mark) {
            present_no.innerHTML = student_checkbox.length;
            absent_no.innerHTML = 0;
        } else {
            absent_no.innerHTML = student_checkbox.length;
            present_no.innerHTML = 0;
        }
    }
    //Toggle between mark attendance and view attendance page.

    function switchAttendance(status) {
        if (status) {
            attendance_view.style.display = "block";
            attendance_mark.style.display = "none";
        } else {
            attendance_mark.style.display = "block";
            attendance_view.style.display = "none";
        }

    }


</script>


{% if type == "view-attendance" %}
<script>
    switchAttendance(true);
</script>

{% elif type == "mark-attendance" %}
<script>
    switchAttendance(false);
</script>

{% endif %}