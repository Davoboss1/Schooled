{% load custom_filter %}
{% if all_Info.object_list.exists %}
{% for info in all_Info %}
<a class="list-group-item list-group-item-action d-flex">{{info.name}}
    <span class="ml-auto">
        <span class="fa fa-minus-circle mr-3" style="color:red;" data-toggle="collapse"
            data-target="#delete-performance{{info.id}}" onclick="">
        </span>
        <span class="fa fa-plus-circle" style="color:green;" data-toggle="collapse"
            data-target="#add-performance-form-{{info.pk}}" onclick=""></span>
    </span>
</a>
<!-- Collapsed container for add performance -->
<!-- add performance container and form -->
<div class="collapse" id="add-performance-form-{{info.pk}}" data-parent="#editPerformanceAccordion">
    <form class="border border-dark px-2" id="performance-add-form-{{info.pk}}"
        hx-post="{% url 'students:performance_update' info.id %}" hx-target="#form-status-{{info.pk}}">
        {% csrf_token %}
        <input class="form-control w-75 mt-2 ml-2" type="hidden" name="name" value="{{info.name}}">
        <label class="vcenter mt-3 ml-2">Enter Subject :
        </label>
        <input class="form-control w-75 mt-2 ml-2" type="text" name="subject" list="subject-list" autocomplete="off">
        <div class="form-row ml-1 mr-1" x-data="{test: 0, exam: 0}">
            <div class="col-5">
                <label>Enter Test Score</label>
                <input class="form-control w-50 test-score" type="number" name="test" x-model="test" >
            </div>
            <div class="col-5">
                <label class="text-nowrap">Enter Exam Score </label>
                <input class="form-control w-50 exam-score" type="number" name="exam" x-model="exam" >
            </div>
            <div class="col-2 d-flex flex-column">
                <strong>
                    Total
                </strong>
                <span class="fa fa-arrow-down mx-auto">
                </span>
                <strong class="mx-auto" id="totalScore" x-text="isNaN(parseInt(test) + parseInt(exam)) ? 0 : (parseInt(test) + parseInt(exam))">
                    --
                </strong>
            </div>
            <div class="col-12">
                <label>
                    Enter Comment
                </label>
                <input class="form-control mb-3" type="text" name="comment">
            </div>

        </div>
        <button class="btn btn-success btn-block mb-3">Create Performance</button>
        <div class="m-2" id="form-status-{{info.pk}}"></div>
    </form>

</div>

<!-- End of add performance container and form -->
<!-- End of form collapse -->
<!-- Delete performance collapsed container -->

<!-- Delete performance tab -->

<div class="collapse" id="delete-performance{{info.id}}" data-parent="#editPerformanceAccordion">
    <!-- Subject list -->
    <ul class="list-group ">

        <li class="list-group-item d-flex">
            <strong class="w-50">
                Subject
            </strong>
            <strong class="w-25">
                Total
            </strong>
        </li>

        {% for performance in info|current_term_filter %}
        <li class="list-group-item d-flex">
            <span style="display:none;">
                {{performance.pk}}
            </span>

            <strong class="w-50">
                {{performance.subject}}
            </strong>
            <strong class="w-25">
                {{performance.total}}
            </strong>
            <button class="btn btn-danger ml-auto deleteBtn" data-pk="{{performance.pk}}" type="button">
                Delete
            </button>
        </li>
        {% endfor %}
    </ul>
    <!-- Subject List end -->
</div>
{% endfor %}
<!-- All added subject datalist -->
<datalist id="subject-list">
    {% for subject in available_subjects %}
    <option>{{subject}}</option>
    {% endfor %}
</datalist>


{% else %}
<a class="list-group-item text-center text-danger">No students in this class</a>

{% endif %}

<!-- pagination -->
<div class="row py-3 border-top border-bottom">
    <div class="col-4 d-flex" style="padding:0; margin:0; height:40px;">
        {% if all_Info.has_previous %}
        <button class="genric-btn primary mx-auto edit-performance-pagination-handler"
            hx-get="{% url 'students:performance_page' 'edit-performance' %}" hx-target="#editPerformanceAccordion" hx-vals='{ "page" : "{{all_Info.previous_page_number}}" }'>
            <span class="fa fa-angle-left mr-1"></span>Prev </button>
        {% endif %}
    </div>
    <div class="col-4 d-flex" style="padding:0; margin:0; height:40px;">
        <select class="form-control mx-auto edit-performance-pagination-handler" style="max-width: 100px;" hx-get="{% url 'students:performance_page' 'edit-performance' %}" hx-target="#editPerformanceAccordion" name="page">
            {% for page_no in all_Info.paginator.page_range %}
            <option {% if page_no == all_Info.number %}selected{% endif %}>{{page_no}}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-4 d-flex" style="padding:0; margin:0; height:40px;">
        {% if all_Info.has_next %}
        <button class="genric-btn primary mx-auto edit-performance-pagination-handler "
        hx-get="{% url 'students:performance_page' 'edit-performance' %}" hx-target="#editPerformanceAccordion" hx-vals='{ "page" : "{{all_Info.next_page_number}}" }'>Next <span class="fa fa-angle-right ml-1"></span></button>
        {% endif %}
    </div>
</div>

<script>
    //Delete 
    document.querySelectorAll('.deleteBtn').forEach(elem => {
        elem.onclick = function () {
            let pk = elem.getAttribute("data-pk");
            Swal.queue([{
                icon: "error",
                confirmButtonText: 'Yes',
                confirmButtonColor: '#d33',
                showCloseButton: true,
                showCancelButton: true,
                title: "Confirm Student Performance Delete.",
                html: "<b class='text-danger mb-2'> Are you sure you want to delete this performance. ",
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return htmx.ajax('POST', "{% url 'students:delete' %}", {
                        target: "#none", values: {
                            csrfmiddlewaretoken: "{{csrf_token}}",
                            pk: pk,
                        }, handler: (elt, res) => {
                            if (res.xhr.status === 200) {
                                Swal.insertQueueStep({
                                    icon: "success",
                                    title: "Performance has been deleted successfully"
                                });
                                elem.textContent = "Deleted";
                                elem.disabled = true;
                            } else {
                                Swal.showValidationMessage("Something went wrong. Please try again.");
                                Swal.hideLoading();
                            }
                        }
                    });
                }
            }]);

        }
    });

    
</script>